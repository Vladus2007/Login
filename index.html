<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekashron SOAP Login (CORS Fixed)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
        }
        h2 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover { background: #2980b9; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .demo-creds {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 25px;
            font-size: 14px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
            max-height: 300px;
            font-size: 12px;
            display: none;
            margin-top: 20px;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîê Mekashron SOAP Login</h2>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" required 
                       placeholder="Enter username" value="test">
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required 
                       placeholder="Enter password" value="test">
            </div>
            
            <button type="submit" class="btn" id="submitBtn">
                <span class="spinner" id="spinner" style="display: none;"></span>
                <span id="btnText">Login via SOAP/WSDL</span>
            </button>
        </form>
        
        <div class="alert" id="alert"></div>
        
        <pre id="result"></pre>
        
        <div class="demo-creds">
            <h4>üìã Test Credentials:</h4>
            <p><strong>Username:</strong> test</p>
            <p><strong>Password:</strong> test</p>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                Using CORS proxy to bypass browser restrictions
            </p>
        </div>
    </div>

    <script>
        // CORS –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–∏—Å—ã (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
        const CORS_PROXIES = [
            'https://corsproxy.io/?url=',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/',
            'https://cors-anywhere.herokuapp.com/'
        ];
        
        // –¢–µ–∫—É—â–∏–π –ø—Ä–æ–∫—Å–∏
        let currentProxyIndex = 0;
        
        function getProxyUrl(targetUrl) {
            return CORS_PROXIES[currentProxyIndex] + encodeURIComponent(targetUrl);
        }
        
        function rotateProxy() {
            currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
            console.log('Switched to proxy:', CORS_PROXIES[currentProxyIndex]);
        }
        
        async function callSOAPService(username, password) {
            const endpoint = 'http://isapi.mekashron.com/icu-tech/icutech-test.dll';
            const proxyUrl = getProxyUrl(endpoint);
            
            const soapRequest = `<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <Login xmlns="urn:ICUTech.Intf-IICUTech">
            <UserName>${escapeXml(username)}</UserName>
            <Password>${escapeXml(password)}</Password>
            <IPs>127.0.0.1</IPs>
        </Login>
    </soap:Body>
</soap:Envelope>`;
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                console.log('Sending request via proxy:', proxyUrl);
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/xml; charset=utf-8',
                        'SOAPAction': 'urn:ICUTech.Intf-IICUTech#Login',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: soapRequest,
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status} ${response.statusText}`);
                }
                
                const xmlText = await response.text();
                console.log('Response received');
                
                // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ SOAP –æ—à–∏–±–∫—É
                const fault = xmlDoc.getElementsByTagName('faultstring')[0];
                if (fault) {
                    throw new Error(`SOAP Error: ${fault.textContent}`);
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const result = xmlDoc.getElementsByTagName('LoginResult')[0];
                if (!result) {
                    throw new Error('Invalid response format - no LoginResult found');
                }
                
                return {
                    success: true,
                    data: result.textContent
                };
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ CORS, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –ø—Ä–æ–∫—Å–∏
                if (error.name === 'AbortError' || error.message.includes('Failed to fetch') || 
                    error.message.includes('NetworkError') || error.message.includes('CORS')) {
                    
                    console.log('Proxy failed, trying next one...');
                    rotateProxy();
                    
                    // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —Å –Ω–æ–≤—ã–º –ø—Ä–æ–∫—Å–∏
                    if (currentProxyIndex !== 0) { // –ù–µ –ø—Ä–æ–±—É–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
                        return callSOAPService(username, password);
                    }
                }
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        function escapeXml(str) {
            return str.replace(/[<>&'"]/g, function(c) {
                switch(c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                    default: return c;
                }
            });
        }
        
        function showAlert(message, type, autoHide = true) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            if (autoHide) {
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function showLoading(show) {
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btnText');
            const submitBtn = document.getElementById('submitBtn');
            
            if (show) {
                spinner.style.display = 'inline-block';
                btnText.textContent = ' Connecting...';
                submitBtn.disabled = true;
            } else {
                spinner.style.display = 'none';
                btnText.textContent = 'Login via SOAP/WSDL';
                submitBtn.disabled = false;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('result');
            
            // –°–±—Ä–æ—Å UI
            showAlert('', 'success', false);
            resultDiv.style.display = 'none';
            showLoading(true);
            
            // –í—ã–∑–æ–≤ SOAP —Å–µ—Ä–≤–∏—Å–∞
            const result = await callSOAPService(username, password);
            
            showLoading(false);
            
            if (result.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                showAlert('‚úÖ Login successful!', 'success', false);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                try {
                    const jsonData = JSON.parse(result.data);
                    resultDiv.textContent = JSON.stringify(jsonData, null, 2);
                } catch {
                    resultDiv.textContent = result.data;
                }
                resultDiv.style.display = 'block';
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                resultDiv.scrollIntoView({ behavior: 'smooth' });
                
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                showAlert(`‚ùå Error: ${result.error}`, 'danger');
                console.error('Login failed:', result.error);
            }
        });
        
        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∫—Å–∏
        async function testConnection() {
            console.log('Testing CORS proxies...');
            showLoading(true);
            
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                currentProxyIndex = i;
                const testResult = await callSOAPService('test', 'test');
                
                if (testResult.success) {
                    console.log(`Proxy ${CORS_PROXIES[i]} works!`);
                    showAlert(`‚úÖ Using proxy: ${CORS_PROXIES[i].split('/')[2]}`, 'success');
                    break;
                } else {
                    console.log(`Proxy ${CORS_PROXIES[i]} failed: ${testResult.error}`);
                }
            }
            
            showLoading(false);
        }
        
        // –ê–≤—Ç–æ-—Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            console.log('Page loaded, testing proxies...');
            // testConnection(); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –∞–≤—Ç–æ-—Ç–µ—Å—Ç–∞
        });
    </script>
</body>
</html>
