<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekashron SOAP Test - Direct</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 15px 0; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Direct SOAP Test (без прокси)</h1>
    
    <div>
        <h3>Проверим прямой запрос:</h3>
        <button onclick="testDirectRequest()">Test Direct Request</button>
        <button onclick="testWithJSONP()">Test with JSONP (alternative)</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        async function testDirectRequest() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">Testing...</div>';
            
            // Создаем правильный SOAP запрос
            const soapRequest = `<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:xsd="http://www.w3.org/2001/XMLSchema">
    <soap:Body>
        <Login xmlns="urn:ICUTech.Intf-IICUTech">
            <UserName>test</UserName>
            <Password>test</Password>
            <IPs>127.0.0.1</IPs>
        </Login>
    </soap:Body>
</soap:Envelope>`;
            
            try {
                // Используем XHR вместо fetch (лучшая совместимость)
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'http://isapi.mekashron.com/icu-tech/icutech-test.dll');
                xhr.setRequestHeader('Content-Type', 'text/xml; charset=utf-8');
                xhr.setRequestHeader('SOAPAction', 'urn:ICUTech.Intf-IICUTech#Login');
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        resultDiv.innerHTML = `<div class="result success">
                            <h4>✅ Success! Status: ${xhr.status}</h4>
                            <pre>${xhr.responseText}</pre>
                        </div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="result error">
                            <h4>❌ Error: ${xhr.status} ${xhr.statusText}</h4>
                            <p>Response headers:</p>
                            <pre>${xhr.getAllResponseHeaders()}</pre>
                        </div>`;
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.innerHTML = `<div class="result error">
                        <h4>❌ Network Error</h4>
                        <p>Это CORS ошибка. Нужен прокси сервер.</p>
                    </div>`;
                };
                
                xhr.send(soapRequest);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">
                    <h4>❌ JavaScript Error</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        }
        
        // Альтернатива: Попробуем через iframe
        function testWithIFrame() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">Creating form...</div>';
            
            // Создаем форму и отправляем через iframe
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'http://isapi.mekashron.com/icu-tech/icutech-test.dll';
            form.target = 'soapFrame';
            form.style.display = 'none';
            
            const soapInput = document.createElement('textarea');
            soapInput.name = 'xml';
            soapInput.value = `<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <Login xmlns="urn:ICUTech.Intf-IICUTech">
            <UserName>test</UserName>
            <Password>test</Password>
            <IPs>127.0.0.1</IPs>
        </Login>
    </soap:Body>
</soap:Envelope>`;
            
            form.appendChild(soapInput);
            document.body.appendChild(form);
            
            // Создаем iframe для ответа
            const iframe = document.createElement('iframe');
            iframe.name = 'soapFrame';
            iframe.style.display = 'none';
            iframe.onload = function() {
                try {
                    const response = iframe.contentDocument.body.innerHTML;
                    resultDiv.innerHTML = `<div class="result success">
                        <h4>✅ Response received via iframe</h4>
                        <pre>${response}</pre>
                    </div>`;
                } catch (e) {
                    resultDiv.innerHTML = `<div class="result">
                        <h4>Response frame loaded (CORS prevented reading)</h4>
                        <p>Это означает запрос ушел, но мы не можем прочитать ответ</p>
                    </div>`;
                }
            };
            
            document.body.appendChild(iframe);
            form.submit();
        }
        
        // Проверка через FormData (обход CORS)
        async function testWithFormData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="result">Trying FormData approach...</div>';
            
            const formData = new FormData();
            formData.append('xml', `<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <Login xmlns="urn:ICUTech.Intf-IICUTech">
            <UserName>test</UserName>
            <Password>test</Password>
            <IPs>127.0.0.1</IPs>
        </Login>
    </soap:Body>
</soap:Envelope>`);
            
            try {
                const response = await fetch('http://isapi.mekashron.com/icu-tech/icutech-test.dll', {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // no-cors режим
                });
                
                // В no-cors режиме мы не можем прочитать ответ, но можем проверить отправку
                resultDiv.innerHTML = `<div class="result">
                    <h4>Request sent with no-cors mode</h4>
                    <p>Статус: ${response.status}</p>
                    <p>Это означает запрос был отправлен, но браузер не дает прочитать ответ из-за CORS</p>
                </div>`;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">
                    <h4>❌ Error with FormData</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        }
        
        // Автотест при загрузке
        window.addEventListener('load', () => {
            console.log('Testing available methods...');
            // testDirectRequest();
        });
    </script>
</body>
</html>
